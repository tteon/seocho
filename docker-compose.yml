version: '3.8'

services:
  # --- Graph Storage ---
  neo4j:
    image: graphstack/dozerdb:5.26.3.0
    container_name: graphrag-neo4j
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474" # HTTP
      - "${NEO4J_BOLT_PORT:-7687}:7687" # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password}
      - NEO4J_PLUGINS=["apoc", "n10s"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_dbms_security_procedures_unrestricted=*
    volumes:
      - ./data/neo4j/data:/data
      - ./data/neo4j/logs:/logs
      - ./data/neo4j/import:/var/lib/neo4j/import
      - ./data/neo4j/plugins:/plugins
    networks:
      - graphrag-net

  neodash:
    image: neo4jlabs/neodash:latest
    container_name: neodash
    ports:
      - "5005:5005"
    environment:
      - ssoEnabled=false
    networks:
      - graphrag-net

  # --- DataHub Prerequisites ---
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.1
    container_name: elasticsearch
    environment:
      - "discovery.type=single-node"
      - "xpack.security.enabled=false"
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - graphrag-net

  mysql:
    image: mysql:5.7
    container_name: mysql
    environment:
      - MYSQL_DATABASE=datahub
      - MYSQL_ROOT_PASSWORD=datahub
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --default-authentication-plugin=mysql_native_password
    volumes:
      - ./data/mysql:/var/lib/mysql
    networks:
      - graphrag-net

  zookeeper:
    image: confluentinc/cp-zookeeper:5.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - graphrag-net

  kafka:
    image: confluentinc/cp-kafka:5.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - graphrag-net

  # --- DataHub Core ---
  datahub-gms:
    image: linkedin/datahub-gms:latest
    container_name: datahub-gms
    ports:
      - "${DATAHUB_GMS_PORT:-8080}:8080"
    environment:
      - DATAHUB_GMS_HOST=${DATAHUB_GMS_HOST:-datahub-gms}
      - DATAHUB_GMS_PORT=8080
      - EBEAN_DATASOURCE_USERNAME=root
      - EBEAN_DATASOURCE_PASSWORD=datahub
      - EBEAN_DATASOURCE_HOST=mysql:3306
      - EBEAN_DATASOURCE_URL=jdbc:mysql://mysql:3306/datahub?verifyServerCertificate=false&useSSL=true&useUnicode=yes&characterEncoding=UTF-8
      - EBEAN_DATASOURCE_DRIVER=com.mysql.jdbc.Driver
      - KAFKA_BOOTSTRAP_SERVER=kafka:29092
      - ELASTICSEARCH_HOST=elasticsearch
      - ELASTICSEARCH_PORT=9200
    depends_on:
      - mysql
      - elasticsearch
      - kafka
    networks:
      - graphrag-net

  datahub-frontend:
    image: linkedin/datahub-frontend-react:latest
    container_name: datahub-frontend
    ports:
      - "${DATAHUB_FRONTEND_PORT:-9002}:9002"
    environment:
      - DATAHUB_GMS_HOST=datahub-gms
      - DATAHUB_GMS_PORT=8080
      - DATAHUB_SECRET=x
      - DATAHUB_PLAY_MEM_BUFFER_SIZE=10MB
      - JAVA_TOOL_OPTIONS=-DDATAHUB_PLAY_MEM_BUFFER_SIZE=10MB
      - KAFKA_BOOTSTRAP_SERVER=kafka:29092
      - ELASTIC_CLIENT_HOST=elasticsearch
      - ELASTIC_CLIENT_PORT=9200
      - DATAHUB_TRACKING_TOPIC=DataHubUsageEvent_v1
      - DATAHUB_APP_VERSION=1.0.0
    depends_on:
      - datahub-gms
    networks:
      - graphrag-net

  # --- Application Services ---
  extraction-service:
    build: ./extraction
    container_name: extraction-service
    ports:
      - "8888:8888"
      - "8001:8001"
    volumes:
      - ./extraction:/app
      - ./notebooks:/app/notebooks
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}
      - DATAHUB_GMS_URL=http://datahub-gms:8080
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - neo4j
      - datahub-gms
    networks:
      - graphrag-net

  semantic-service:
    build: ./semantic
    container_name: semantic-service
    volumes:
      - ./semantic:/app
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}
      - DATAHUB_GMS_URL=http://datahub-gms:8080
    depends_on:
      - neo4j
      - datahub-gms
    networks:
      - graphrag-net

  chat-interface:
    build: ./chat
    container_name: chat-interface
    ports:
      - "${CHAT_INTERFACE_PORT:-8501}:8501"
    environment:
      - EXTRACTION_SERVICE_URL=http://extraction-service:8001
      - SEMANTIC_SERVICE_URL=http://semantic-service:8000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - extraction-service
      - semantic-service
    networks:
      - graphrag-net

    networks:
      - graphrag-net

networks:
  graphrag-net:
    driver: bridge
